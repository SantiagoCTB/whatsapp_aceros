<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Chat Tecnimedellín</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<div style="position: absolute; bottom: 20px; left: 20px; display: flex; gap: 10px;">
    <a href="{{ url_for('configuracion.configuracion') }}"
       style="background-color: #2980b9; color: white;
              padding: 8px 16px; text-decoration: none;
              border-radius: 5px; font-size: 14px;">
        Configuración
    </a>
    <a href="{{ url_for('configuracion.botones') }}"
       style="background-color: #16a085; color: white;
              padding: 8px 16px; text-decoration: none;
              border-radius: 5px; font-size: 14px;">
        Botones
    </a>
    <a href="{{ url_for('auth.logout') }}"
       style="background-color: #e74c3c; color: white;
              padding: 8px 16px; text-decoration: none;
              border-radius: 5px; font-size: 14px;">
        Cerrar sesión
    </a>
</div>

<body>
    <div class="container">
        <div class="sidebar">
            <h2>Clientes</h2>
            <ul id="chatList"></ul>
        </div>
        <div class="chatWindow">

            <!-- NUEVA BARRA DE BOTONES -->
            <div id="botonera" style="display: flex; gap: 10px; padding: 10px; overflow-x: auto;"></div>

            <div id="chatBox"></div>
            <div class="inputArea">
                <input type="text" id="messageInput" placeholder="Escribe un mensaje...">
                <button onclick="sendMessage()">Enviar</button>
            </div>
        </div>
    </div>

    <script>
        let currentChat = null;
        let autoRefreshInterval = null;

        function fetchChat() {
            if (!currentChat) return;
            fetch(`/get_chat/${currentChat}`)
                .then(res => res.json())
                .then(data => {
                    const chatBox = document.getElementById('chatBox');
                    chatBox.innerHTML = '';
                    data.mensajes.forEach(msg => {
                        const div = document.createElement('div');
                        div.className = msg[1]; // cliente, bot, asesor
                        div.textContent = `[${msg[2]}] ${msg[1]}: ${msg[0]}`;
                        chatBox.appendChild(div);
                    });
                    chatBox.scrollTop = chatBox.scrollHeight;
                });
        }

        function fetchChatList() {
            fetch('/get_chat_list')
                .then(res => res.json())
                .then(data => {
                    const chatList = document.getElementById('chatList');
                    chatList.innerHTML = '';
                    data.forEach(chat => {
                        const li = document.createElement('li');
                        li.textContent = chat.numero;
                        li.className = chat.asesor ? 'asesor-activo' : '';
                        li.onclick = () => loadChat(chat.numero);
                        chatList.appendChild(li);
                    });
                });
        }

        function loadChat(numero) {
            currentChat = numero;
            fetchChat();
            startAutoRefresh();
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                fetchChatList();
                fetchChat();
            }, 3000);
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const mensaje = input.value;
            if (!mensaje || !currentChat) return alert("Selecciona un chat");
            fetch('/send_message', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({numero: currentChat, mensaje})
            }).then(() => {
                input.value = '';
                fetchChat();
                fetchChatList();
            });
        }

        // Permitir enviar con Enter
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('messageInput');
            input.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    sendMessage();
                }
            });

            fetchChatList();
            fetchBotones();  // Cargar los botones al iniciar
        });

        // NUEVO: Cargar botones predeterminados
        function fetchBotones() {
            fetch('/get_botones')
                .then(res => res.json())
                .then(data => {
                    const contenedor = document.getElementById('botonera');
                    contenedor.innerHTML = '';
                    data.forEach((boton, i) => {
                        const btn = document.createElement('button');
                        btn.textContent = i + 1;
                        btn.title = boton.mensaje;
                        btn.style = `
                            width: 35px;
                            height: 35px;
                            border-radius: 50%;
                            border: none;
                            background-color: #3498db;
                            color: white;
                            font-weight: bold;
                            cursor: pointer;
                        `;
                        btn.onclick = () => {
                            if (!currentChat) return alert("Selecciona un chat");
                            fetch('/send_message', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({numero: currentChat, mensaje: boton.mensaje})
                            }).then(() => {
                                fetchChat();
                                fetchChatList();
                            });
                        };
                        contenedor.appendChild(btn);
                    });
                });
        }
    </script>
</body>
</html>
