<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat TecnimedellÃ­n</title>
  <style>
    :root {
      --bg-page:       #fafafa;
      --bg-sidebar:    #a8dadc;
      --bg-chat:       #f1faee;
      --accent:        #457b9d;
      --accent-hover:  #1d3557;
      --bubble-user:   #e9c46a;
      --bubble-bot:    #81b29a;
      --bubble-asesor: #f4a261;
      --text-main:     #1d3557;
      --text-light:    #ffffff;
      --font-base:     'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      display: flex;
      height: 100vh;
      font-family: var(--font-base);
      background: var(--bg-page);
    }

    .container {
      display: flex;
      width: 100%;
      margin: auto;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      background: var(--bg-chat);
    }

    /* Sidebar */
    .sidebar {
      width: 25%;
      background: var(--bg-sidebar);
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 16px;
      color: var(--text-main);
      font-weight: normal;
    }
    #buscador {
      padding: 8px;
      border-radius: 8px;
      border: none;
      margin-bottom: 12px;
      font-size: 14px;
    }
    #chatList {
      list-style: none;
      overflow-y: auto;
      flex: 1;
    }
    #chatList li {
      padding: 12px;
      margin-bottom: 6px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
      color: var(--text-main);
    }
    #chatList li:hover {
      background: var(--accent-hover);
      color: var(--text-light);
      transform: translateX(4px);
    }
    #chatList li.active {
      background: var(--accent);
      color: var(--text-light);
    }

    /* Chat Window */
    .chatWindow {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      background: var(--bg-chat);
    }
    #botonera {
      display: flex;
      gap: 8px;
      padding: 12px;
      overflow-x: auto;
      background: var(--bg-chat);
    }
    #botonera button {
      width: 36px; height: 36px;
      border: none; border-radius: 50%;
      background: var(--accent);
      color: var(--text-light);
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, background 0.3s;
      position: relative;
      overflow: hidden;
    }
    #botonera button:hover {
      transform: scale(1.1);
      background: var(--accent-hover);
    }

    #chatBox {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Bubbles */
    .cliente {
      align-self: flex-start;
      background: var(--bubble-user);
      color: var(--text-main);
    }
    .bot {
      align-self: flex-start;
      background: var(--bubble-bot);
      color: var(--text-light);
    }
    .asesor {
      align-self: flex-end;
      background: var(--bubble-asesor);
      color: var(--text-main);
      font-weight: bold;
    }
    .cliente, .bot, .asesor {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 16px;
      word-wrap: break-word;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Input area */
    .inputArea {
      display: flex;
      align-items: center;
      padding: 12px;
      background: var(--text-light);
      border-top: 1px solid #ddd;
    }
    #attachBtn {
      width: 40px; height: 40px;
      border: none; border-radius: 50%;
      background: var(--accent);
      color: var(--text-light);
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.2s, background 0.3s;
      margin-right: 12px;
      position: relative;
      overflow: hidden;
    }
    #attachBtn:hover {
      transform: rotate(90deg);
      background: var(--accent-hover);
    }
    .attach-menu {
      position: absolute;
      bottom: 60px;
      left: 20px;
      background: var(--text-light);
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      opacity: 0;
      transform: scale(0.8);
      transform-origin: bottom left;
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
      z-index: 10;
    }
    .attach-menu.show {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }
    .attach-item {
      width: 36px; height: 36px;
      margin: 8px;
      border-radius: 50%;
      background: var(--accent);
      color: var(--text-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: transform 0.2s, background 0.3s;
    }
    .attach-item:hover {
      transform: scale(1.2);
      background: var(--accent-hover);
    }

    #messageInput {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #ccc;
      border-radius: 20px;
      font-size: 14px;
      outline: none;
      margin-right: 12px;
    }
    #sendBtn {
      padding: 10px 20px;
      border: none; border-radius: 20px;
      background: var(--accent);
      color: var(--text-light);
      cursor: pointer;
      transition: transform 0.2s, background 0.3s;
      position: relative;
      overflow: hidden;
    }
    #sendBtn:hover {
      transform: scale(1.05);
      background: var(--accent-hover);
    }
    /* ripple effect */
    button:after {
      content: '';
      position: absolute;
      width: 100px; height: 100px;
      background: rgba(255,255,255,0.3);
      border-radius: 50%;
      transform: scale(0);
      opacity: 0;
      transition: transform 0.5s, opacity 0.8s;
    }
    button:active:after {
      transform: scale(1);
      opacity: 1;
      transition: 0s;
    }
  </style>
</head>
<body>

  <!-- Sidebar & Chat -->
  <div class="container">
    <div class="sidebar">
      <h2>Clientes</h2>
      <input id="buscador" type="text" placeholder="Buscar nÃºmeroâ€¦">
      <ul id="chatList"></ul>
    </div>

    <div class="chatWindow">
      <div id="botonera"></div>
      <div id="chatBox"></div>
      <div class="inputArea">
        <button id="attachBtn">+</button>
        <div id="attachMenu" class="attach-menu">
          <div id="attachImage" class="attach-item" title="Enviar imagen">ðŸ“·</div>
          <div id="attachAudio" class="attach-item" title="Enviar audio">ðŸŽ¤</div>
          <div id="attachVideo" class="attach-item" title="Enviar video">ðŸŽ¥</div>
        </div>
        <input id="messageInput" type="text" placeholder="Escribe un mensajeâ€¦">
        <button id="sendBtn">Enviar</button>
        <input id="imageInput" type="file" accept="image/*" style="display:none;">
        <input id="audioInput" type="file" accept="audio/*" style="display:none;">
        <input id="videoInput" type="file" accept="video/*" style="display:none;">
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    let currentChat = null;
    let autoRefresh = null;
    let todosChats = [];
    let lastCount = 0;

    const chatListEl = document.getElementById('chatList');
    const chatBoxEl  = document.getElementById('chatBox');
    const botoneraEl = document.getElementById('botonera');

    function fetchChatList() {
      fetch('/get_chat_list')
        .then(r=>r.json())
        .then(data=>{
          todosChats = data;
          chatListEl.innerHTML = '';
          data.forEach(c=>{
            const li = document.createElement('li');
            li.textContent = c.alias? `${c.alias} (${c.numero})` : c.numero;
            li.onclick = ()=>selectChat(c.numero, li);
            chatListEl.appendChild(li);
          });
        });
    }

    function selectChat(numero, liEl) {
      currentChat = numero;
      lastCount = 0;
      // active styling
      document.querySelectorAll('#chatList li').forEach(li=>li.classList.remove('active'));
      liEl.classList.add('active');
      if (autoRefresh) clearInterval(autoRefresh);
      autoRefresh = setInterval(loadMessages, 3000);
      loadMessages();
      loadBotonera();
    }

    function loadMessages() {
      if (!currentChat) return;
      // don't interrupt media
      const mediaEls = chatBoxEl.querySelectorAll('audio, video');
      for (let m of mediaEls) {
        if (!m.paused) return;
      }
      fetch(`/get_chat/${currentChat}`)
        .then(r=>r.json())
        .then(data=>{
          const msgs = data.mensajes;
          const total = msgs.length;
          const atBottom = chatBoxEl.scrollTop + chatBoxEl.clientHeight >= chatBoxEl.scrollHeight - 5;
          if (lastCount===0 || total<lastCount) {
            chatBoxEl.innerHTML='';
            lastCount=0;
          }
          for (let i=lastCount;i<total;i++){
            const [txt, tipo, url, ts] = msgs[i];
            const div = document.createElement('div');
            div.className = tipo+' message';
            if (tipo.endsWith('_image') && url) {
              const img = document.createElement('img');
              img.src=url; img.style.maxWidth='200px'; div.appendChild(img);
            } else if (tipo.includes('audio') && url) {
              const a = document.createElement('audio');
              a.controls=true; a.src=url; div.appendChild(a);
            } else if (tipo.includes('video') && url) {
              const v = document.createElement('video');
              v.controls=true; v.src=url; v.style.maxWidth='200px'; div.appendChild(v);
            } else {
              div.textContent=`[${ts}] ${tipo}: ${txt}`;
            }
            if (txt && !tipo.endsWith('_image')) {
              const p = document.createElement('p');
              p.textContent = txt;
              div.appendChild(p);
            }
            chatBoxEl.appendChild(div);
          }
          lastCount = total;
          if (atBottom) chatBoxEl.scrollTop = chatBoxEl.scrollHeight;
        });
    }

    // Botonera rÃ¡pida
    function loadBotonera() {
      fetch('/get_botones')
        .then(r=>r.json())
        .then(btns=>{
          botoneraEl.innerHTML='';
          btns.forEach((b,i)=>{
            const btn = document.createElement('button');
            btn.textContent = i+1;
            btn.onclick = ()=> {
              fetch('/send_message',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({numero:currentChat,mensaje:b.mensaje})
              }).then(()=>{
                loadMessages();
                fetchChatList();
              });
            };
            botoneraEl.appendChild(btn);
          });
        });
    }

    // Send text
    document.getElementById('sendBtn').addEventListener('click', ()=>{
      const inp = document.getElementById('messageInput');
      const txt = inp.value.trim();
      if (!txt||!currentChat) return;
      fetch('/send_message',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({numero:currentChat,mensaje:txt})
      }).then(()=>{
        inp.value=''; loadMessages(); fetchChatList();
      });
    });

    // Attach menu
    const attachBtn = document.getElementById('attachBtn');
    const attachMenu = document.getElementById('attachMenu');
    attachBtn.onclick = e=> {
      e.stopPropagation();
      attachMenu.classList.toggle('show');
    };
    document.addEventListener('click', ()=>attachMenu.classList.remove('show'));

    // File inputs
    const imgIn = document.getElementById('imageInput');
    const audIn = document.getElementById('audioInput');
    const vidIn = document.getElementById('videoInput');
    document.getElementById('attachImage').onclick = ()=>imgIn.click();
    document.getElementById('attachAudio').onclick = ()=>audIn.click();
    document.getElementById('attachVideo').onclick = ()=>vidIn.click();

    async function sendFile(inputEl, path) {
      if (!currentChat) return;
      const file = inputEl.files[0];
      if (!file) return;
      const form = new FormData();
      form.append(path.split('_')[1], file);
      form.append('caption','');
      form.append('numero', currentChat);
      const res = await fetch(`/${path}`, {method:'POST',body:form});
      if (!res.ok) return;
      inputEl.value=''; attachMenu.classList.remove('show');
      loadMessages(); fetchChatList();
    }
    imgIn.onchange = ()=>sendFile(imgIn,'send_image');
    audIn.onchange = ()=>sendFile(audIn,'send_audio');
    vidIn.onchange = ()=>sendFile(vidIn,'send_video');

    // Search filter
    document.getElementById('buscador').addEventListener('input', function(){
      const v = this.value.toLowerCase();
      document.querySelectorAll('#chatList li').forEach(li=>{
        li.style.display = li.textContent.toLowerCase().includes(v)? '' : 'none';
      });
    });

    // Init
    fetchChatList();
  });
  </script>
</body>
</html>
